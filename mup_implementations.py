"""
    This file contains "implementations" of muP. There are different ways to implement
    the same paramaterization, and this file contains some examples. For example, we 
    may not want to initialize the parameters to be too small.
"""
import math

# moe_normalization = {(16, 1): {'mean': 0.01547195389866829, 'second_moment': 0.0043950434774160385, 'var': 0.0043950434774160385}, (16, 2): {'mean': 0.02429725043475628, 'second_moment': 0.0056337034329771996, 'var': 0.005340856499969959}, (32, 1): {'mean': 0.0050145359709858894, 'second_moment': 0.0009274088661186397, 'var': 0.0009274088661186397}, (32, 2): {'mean': 0.008538671769201756, 'second_moment': 0.0013688497710973024, 'var': 0.001332347048446536}, (32, 4): {'mean': 0.012858767062425613, 'second_moment': 0.0016539358766749501, 'var': 0.0015310612507164478}, (32, 6): {'mean': 0.016404369845986366, 'second_moment': 0.001887441729195416, 'var': 0.0016659017419442534}, (64, 1): {'mean': 0.001678807777352631, 'second_moment': 0.00021157803712412715, 'var': 0.00021157803712412715}, (64, 2): {'mean': 0.0028051871340721846, 'second_moment': 0.0002997160190716386, 'var': 0.00029580091359093785}, (64, 4): {'mean': 0.004376308526843786, 'second_moment': 0.00037874325062148273, 'var': 0.00036441677366383374}, (64, 6): {'mean': 0.005642833653837442, 'second_moment': 0.00041966678691096604, 'var': 0.00039323625969700515}, (64, 8): {'mean': 0.0067062354646623135, 'second_moment': 0.0004723559250123799, 'var': 0.0004333681717980653}, (96, 1): {'mean': 0.0008531124331057072, 'second_moment': 8.394233009312302e-05, 'var': 8.394233009312302e-05}, (96, 2): {'mean': 0.001444641500711441, 'second_moment': 0.00011901423567906022, 'var': 0.00011796689796028659}, (96, 4): {'mean': 0.0023627590853720903, 'second_moment': 0.00016536566545255482, 'var': 0.00016118932398967445}, (96, 6): {'mean': 0.002955435775220394, 'second_moment': 0.00017455393390264362, 'var': 0.00016728458285797387}, (96, 8): {'mean': 0.003553887130692601, 'second_moment': 0.0001940723304869607, 'var': 0.00018310653103981167}, (128, 1): {'mean': 0.0005325487582013011, 'second_moment': 4.178151721134782e-05, 'var': 4.178151721134782e-05}, (128, 2): {'mean': 0.0008786571561358869, 'second_moment': 5.7980723795481026e-05, 'var': 5.759113992098719e-05}, (128, 4): {'mean': 0.0014499116223305464, 'second_moment': 8.140745921991765e-05, 'var': 7.983914838405326e-05}, (128, 6): {'mean': 0.0018802577396854758, 'second_moment': 9.43701816140674e-05, 'var': 9.14352058316581e-05}, (128, 8): {'mean': 0.002260832581669092, 'second_moment': 0.00010461367492098361, 'var': 0.00010016431042458862}, (160, 1): {'mean': 0.0003685645933728665, 'second_moment': 2.587492417660542e-05, 'var': 2.587492417660542e-05}, (160, 2): {'mean': 0.0006289900629781187, 'second_moment': 3.7790498026879504e-05, 'var': 3.7590678402921185e-05}, (160, 4): {'mean': 0.0009955544956028461, 'second_moment': 4.764436016557738e-05, 'var': 4.690006608143449e-05}, (160, 6): {'mean': 0.0013121343217790127, 'second_moment': 5.571982546825893e-05, 'var': 5.428095391835086e-05}, (160, 8): {'mean': 0.0015899591380730271, 'second_moment': 6.401608698070049e-05, 'var': 6.181369099067524e-05}, (192, 1): {'mean': 0.0002732138673309237, 'second_moment': 1.6396628780057654e-05, 'var': 1.6396628780057654e-05}, (192, 2): {'mean': 0.0004633675853256136, 'second_moment': 2.5050818294403143e-05, 'var': 2.4938613933045417e-05}, (192, 4): {'mean': 0.0007485190872102976, 'second_moment': 3.297100920462981e-05, 'var': 3.254988769185729e-05}, (192, 6): {'mean': 0.000977308489382267, 'second_moment': 3.7663830880774185e-05, 'var': 3.687079151859507e-05}, (192, 8): {'mean': 0.0011840570950880647, 'second_moment': 4.1920895455405116e-05, 'var': 4.0695700590731576e-05}, (256, 1): {'mean': 0.0001677306863712147, 'second_moment': 8.981397513707634e-06, 'var': 8.981397513707634e-06}, (256, 2): {'mean': 0.00028188235592097044, 'second_moment': 1.2087404684280045e-05, 'var': 1.2046570191159844e-05}, (256, 4): {'mean': 0.00045969229540787637, 'second_moment': 1.58758648467483e-05, 'var': 1.5716639609308913e-05}, (256, 6): {'mean': 0.0006163989892229438, 'second_moment': 1.970986522792373e-05, 'var': 1.9392380636418238e-05}, (256, 8): {'mean': 0.0007432695711031556, 'second_moment': 2.182049138355069e-05, 'var': 2.1337315047276206e-05}, (288, 1): {'mean': 0.0001413515128660947, 'second_moment': 6.713459242746467e-06, 'var': 6.713459242746467e-06}, (288, 2): {'mean': 0.00023551103367935866, 'second_moment': 9.322157893620897e-06, 'var': 9.293853509007022e-06}, (288, 4): {'mean': 0.00038349369424395263, 'second_moment': 1.2528146726253908e-05, 'var': 1.2416461686370894e-05}, (288, 6): {'mean': 0.0005038768285885453, 'second_moment': 1.4882522009429522e-05, 'var': 1.4671314602310304e-05}, (288, 8): {'mean': 0.000609832291956991, 'second_moment': 1.650714511924889e-05, 'var': 1.6180665625142865e-05}, (384, 1): {'mean': 8.357792103197426e-05, 'second_moment': 3.201460231139208e-06, 'var': 3.2014600037655327e-06}, (384, 2): {'mean': 0.00014196512347552925, 'second_moment': 4.580230779538397e-06, 'var': 4.5700262489845045e-06}, (384, 4): {'mean': 0.00023344690271187574, 'second_moment': 6.014538939780323e-06, 'var': 5.973224688204937e-06}, (384, 6): {'mean': 0.00031763085280545056, 'second_moment': 7.613180969201494e-06, 'var': 7.528639343945542e-06}, (384, 8): {'mean': 0.00037939497269690037, 'second_moment': 8.39989024825627e-06, 'var': 8.273810635728296e-06}}
# moe_normalization = {(16, 1): {'mean': 0.0625, 'second_moment': 0.0625, 'var': 0.0625}, (16, 2): {'mean': 0.0625, 'second_moment': 0.033916573971509933, 'var': 0.0320110097527504}, (16, 4): {'mean': 0.0625, 'second_moment': 0.01880607195198536, 'var': 0.01589314453303814}, (16, 6): {'mean': 0.0625, 'second_moment': 0.01411302201449871, 'var': 0.010887223295867443}, (16, 8): {'mean': 0.0625, 'second_moment': 0.011723143979907036, 'var': 0.008338019251823425}, (32, 1): {'mean': 0.03125, 'second_moment': 0.03125, 'var': 0.03125}, (32, 2): {'mean': 0.03125, 'second_moment': 0.016787925735116005, 'var': 0.01632140763103962}, (32, 4): {'mean': 0.03125, 'second_moment': 0.00905268732458353, 'var': 0.008336645551025867}, (32, 6): {'mean': 0.03125, 'second_moment': 0.006467638071626425, 'var': 0.005668207537382841}, (32, 8): {'mean': 0.03125, 'second_moment': 0.005067960359156132, 'var': 0.004223378840833902}, (64, 1): {'mean': 0.015625, 'second_moment': 0.015625, 'var': 0.015625}, (64, 2): {'mean': 0.015625, 'second_moment': 0.008229429833590984, 'var': 0.008112039417028427}, (64, 4): {'mean': 0.015625, 'second_moment': 0.00446936534717679, 'var': 0.004292291589081287}, (64, 6): {'mean': 0.015625, 'second_moment': 0.0030782592948526144, 'var': 0.0028791045770049095}, (64, 8): {'mean': 0.015625, 'second_moment': 0.002466354053467512, 'var': 0.0022574865724891424}, (96, 1): {'mean': 0.0104166679084301, 'second_moment': 0.0104166679084301, 'var': 0.0104166679084301}, (96, 2): {'mean': 0.0104166679084301, 'second_moment': 0.005478119943290949, 'var': 0.005426134914159775}, (96, 4): {'mean': 0.0104166679084301, 'second_moment': 0.0029078221414238214, 'var': 0.0028287814930081367}, (96, 6): {'mean': 0.0104166679084301, 'second_moment': 0.002032627584412694, 'var': 0.0019443746423348784}, (96, 8): {'mean': 0.010416666977107525, 'second_moment': 0.0015953290276229382, 'var': 0.0015024726744741201}, (128, 1): {'mean': 0.0078125, 'second_moment': 0.0078125, 'var': 0.0078125}, (128, 2): {'mean': 0.0078125, 'second_moment': 0.004081728868186474, 'var': 0.004052353091537952}, (128, 4): {'mean': 0.0078125, 'second_moment': 0.002173644257709384, 'var': 0.0021292436867952347}, (128, 6): {'mean': 0.0078125, 'second_moment': 0.0014935785438865423, 'var': 0.0014438232174143195}, (128, 8): {'mean': 0.0078125, 'second_moment': 0.0011599297868087888, 'var': 0.0011075473157688975}, (160, 1): {'mean': 0.006250001024454832, 'second_moment': 0.006250001024454832, 'var': 0.006250001024454832}, (160, 2): {'mean': 0.006250001024454832, 'second_moment': 0.0032736631110310555, 'var': 0.0032549439929425716}, (160, 4): {'mean': 0.006250001024454832, 'second_moment': 0.0017443380784243345, 'var': 0.0017160006100311875}, (160, 6): {'mean': 0.006250001024454832, 'second_moment': 0.0012167622335255146, 'var': 0.0011851065792143345}, (160, 8): {'mean': 0.006250000558793545, 'second_moment': 0.0009247377165593207, 'var': 0.0008912454941309988}, (192, 1): {'mean': 0.00520833395421505, 'second_moment': 0.00520833395421505, 'var': 0.00520833395421505}, (192, 2): {'mean': 0.00520833395421505, 'second_moment': 0.0027292484883219004, 'var': 0.002716268878430128}, (192, 4): {'mean': 0.00520833395421505, 'second_moment': 0.0014389008283615112, 'var': 0.001419165637344122}, (192, 6): {'mean': 0.00520833395421505, 'second_moment': 0.000989018939435482, 'var': 0.0009669283754192293}, (192, 8): {'mean': 0.00520833395421505, 'second_moment': 0.0007598083466291428, 'var': 0.000736517715267837}, (256, 1): {'mean': 0.00390625, 'second_moment': 0.00390625, 'var': 0.00390625}, (256, 2): {'mean': 0.00390625, 'second_moment': 0.0020325195509940386, 'var': 0.0020251714158803225}, (256, 4): {'mean': 0.00390625, 'second_moment': 0.001071098493412137, 'var': 0.0010599802481010556}, (256, 6): {'mean': 0.00390625, 'second_moment': 0.0007360557210631669, 'var': 0.0007236235542222857}, (256, 8): {'mean': 0.00390625, 'second_moment': 0.0005705830990336835, 'var': 0.0005575019749812782}, (288, 1): {'mean': 0.0034722224809229374, 'second_moment': 0.0034722224809229374, 'var': 0.0034722224809229374}, (288, 2): {'mean': 0.0034722224809229374, 'second_moment': 0.001807409687899053, 'var': 0.0018016090616583824}, (288, 4): {'mean': 0.0034722224809229374, 'second_moment': 0.000943000428378582, 'var': 0.000934187846723944}, (288, 6): {'mean': 0.0034722224809229374, 'second_moment': 0.000645574415102601, 'var': 0.0006357254460453987}, (288, 8): {'mean': 0.0034722224809229374, 'second_moment': 0.0005028628511354327, 'var': 0.0004925166140310466}, (384, 1): {'mean': 0.002604166977107525, 'second_moment': 0.002604166977107525, 'var': 0.002604166977107525}, (384, 2): {'mean': 0.002604166977107525, 'second_moment': 0.0013605488929897547, 'var': 0.0013573018368333578}, (384, 4): {'mean': 0.002604166977107525, 'second_moment': 0.0007114792242646217, 'var': 0.0007065375684760511}, (384, 6): {'mean': 0.0026041667442768812, 'second_moment': 0.0004842511552851647, 'var': 0.00047871607239358127}, (384, 8): {'mean': 0.002604166977107525, 'second_moment': 0.00037192340823821723, 'var': 0.0003660951042547822}}
# moe_normalization = {(16, 1): {'mean': 0.0625, 'second_moment': 0.0625, 'var': 0.0625}, (16, 2): {'mean': 0.0625, 'second_moment': 0.031321536749601364, 'var': 0.029242973774671555}, (16, 4): {'mean': 0.0625, 'second_moment': 0.015768006443977356, 'var': 0.012652539648115635}, (16, 6): {'mean': 0.0625, 'second_moment': 0.010644383728504181, 'var': 0.00718734273687005}, (16, 8): {'mean': 0.0625, 'second_moment': 0.008157041855156422, 'var': 0.004534177482128143}, (32, 1): {'mean': 0.03125, 'second_moment': 0.03125, 'var': 0.03125}, (32, 2): {'mean': 0.03125, 'second_moment': 0.01563277095556259, 'var': 0.015128988772630692}, (32, 4): {'mean': 0.03125, 'second_moment': 0.007828155532479286, 'var': 0.007072612177580595}, (32, 6): {'mean': 0.03125, 'second_moment': 0.005233419127762318, 'var': 0.004394174553453922}, (32, 8): {'mean': 0.03125, 'second_moment': 0.003939130809158087, 'var': 0.0030581350438296795}, (64, 1): {'mean': 0.015625, 'second_moment': 0.015625, 'var': 0.015625}, (64, 2): {'mean': 0.015625, 'second_moment': 0.007813496515154839, 'var': 0.007689503952860832}, (64, 4): {'mean': 0.015625, 'second_moment': 0.003907999489456415, 'var': 0.0037220155354589224}, (64, 6): {'mean': 0.015625, 'second_moment': 0.002606845460832119, 'var': 0.0024002082645893097}, (64, 8): {'mean': 0.015625, 'second_moment': 0.001956591848284006, 'var': 0.0017396330367773771}, (96, 1): {'mean': 0.010416666977107525, 'second_moment': 0.010416666977107525, 'var': 0.010416666977107525}, (96, 2): {'mean': 0.010416666977107525, 'second_moment': 0.005208613816648722, 'var': 0.005153792444616556}, (96, 4): {'mean': 0.010416666977107525, 'second_moment': 0.002604731125757098, 'var': 0.0025224999990314245}, (96, 6): {'mean': 0.01041666604578495, 'second_moment': 0.0017369341803714633, 'var': 0.001645568641833961}, (96, 8): {'mean': 0.010416666977107525, 'second_moment': 0.0013030964182689786, 'var': 0.0012071641394868493}, (128, 1): {'mean': 0.0078125, 'second_moment': 0.0078125, 'var': 0.0078125}, (128, 2): {'mean': 0.0078125, 'second_moment': 0.00390637619420886, 'var': 0.0038756190333515406}, (128, 4): {'mean': 0.0078125, 'second_moment': 0.0019533552695065737, 'var': 0.0019072203431278467}, (128, 6): {'mean': 0.0078125, 'second_moment': 0.0013024143408983946, 'var': 0.0012511537643149495}, (128, 8): {'mean': 0.0078125, 'second_moment': 0.000976997660472989, 'var': 0.0009231748408637941}, (160, 1): {'mean': 0.006250000558793545, 'second_moment': 0.006250000558793545, 'var': 0.006250000558793545}, (160, 2): {'mean': 0.006250000558793545, 'second_moment': 0.0031250619795173407, 'var': 0.0031054082792252302}, (160, 4): {'mean': 0.006250000558793545, 'second_moment': 0.0015626194654032588, 'var': 0.001533139031380415}, (160, 6): {'mean': 0.006250000558793545, 'second_moment': 0.001041834126226604, 'var': 0.0010090783471241593}, (160, 8): {'mean': 0.006250000558793545, 'second_moment': 0.000781465379986912, 'var': 0.0007470720447599888}, (192, 1): {'mean': 0.0052083334885537624, 'second_moment': 0.0052083334885537624, 'var': 0.0052083334885537624}, (192, 2): {'mean': 0.0052083334885537624, 'second_moment': 0.002604204695671797, 'var': 0.00259057036601007}, (192, 4): {'mean': 0.0052083334885537624, 'second_moment': 0.0013021560152992606, 'var': 0.0012817048700526357}, (192, 6): {'mean': 0.0052083334885537624, 'second_moment': 0.0008681503823027015, 'var': 0.0008454268681816757}, (192, 8): {'mean': 0.0052083334885537624, 'second_moment': 0.0006511642131954432, 'var': 0.0006273047183640301}, (256, 1): {'mean': 0.00390625, 'second_moment': 0.00390625, 'var': 0.00390625}, (256, 2): {'mean': 0.00390625, 'second_moment': 0.00195313966833055, 'var': 0.0019454803550615907}, (256, 4): {'mean': 0.00390625, 'second_moment': 0.000976592069491744, 'var': 0.0009651032160036266}, (256, 6): {'mean': 0.00390625, 'second_moment': 0.0006510820239782333, 'var': 0.0006383166764862835}, (256, 8): {'mean': 0.00390625, 'second_moment': 0.0004883320652879775, 'var': 0.00047492849989794195}, (288, 1): {'mean': 0.0034722229465842247, 'second_moment': 0.0034722229465842247, 'var': 0.0034722229465842247}, (288, 2): {'mean': 0.0034722229465842247, 'second_moment': 0.0017361229984089732, 'var': 0.0017300739418715239}, (288, 4): {'mean': 0.0034722229465842247, 'second_moment': 0.000868074654135853, 'var': 0.0008590008947066963}, (288, 6): {'mean': 0.0034722229465842247, 'second_moment': 0.0005787311820313334, 'var': 0.0005686493241228163}, (288, 8): {'mean': 0.0034722229465842247, 'second_moment': 0.0004340629675425589, 'var': 0.0004234770603943616}, (384, 1): {'mean': 0.0026041667442768812, 'second_moment': 0.0026041667442768812, 'var': 0.0026041667442768812}, (384, 2): {'mean': 0.0026041667442768812, 'second_moment': 0.0013020882615819573, 'var': 0.0012986885849386454}, (384, 4): {'mean': 0.0026041667442768812, 'second_moment': 0.0006510498351417482, 'var': 0.0006459503783844411}, (384, 6): {'mean': 0.0026041667442768812, 'second_moment': 0.0004340395680628717, 'var': 0.0004283734306227416}, (384, 8): {'mean': 0.0026041667442768812, 'second_moment': 0.0003255348710808903, 'var': 0.00031958543695509434}}
# moe_normalization = {(16, 1): {'mean': 0.0625, 'second_moment': 0.0625, 'var': 0.0625}, (16, 2): {'mean': 0.0625, 'second_moment': 0.03131549060344696, 'var': 0.02923651970922947}, (16, 4): {'mean': 0.0625, 'second_moment': 0.015768032521009445, 'var': 0.012652568519115448}, (16, 6): {'mean': 0.0625, 'second_moment': 0.010655800811946392, 'var': 0.00719952117651701}, (16, 8): {'mean': 0.0625, 'second_moment': 0.008192280307412148, 'var': 0.004571766126900911}, (32, 1): {'mean': 0.03125, 'second_moment': 0.03125, 'var': 0.03125}, (32, 2): {'mean': 0.03125, 'second_moment': 0.015632813796401024, 'var': 0.015129035338759422}, (32, 4): {'mean': 0.03125, 'second_moment': 0.007829384878277779, 'var': 0.007073881104588509}, (32, 6): {'mean': 0.03125, 'second_moment': 0.005232358817011118, 'var': 0.004393080249428749}, (32, 8): {'mean': 0.03125, 'second_moment': 0.003937399014830589, 'var': 0.0030563471373170614}, (32, 16): {'mean': 0.03125, 'second_moment': 0.002032127697020769, 'var': 0.0010896158637478948}, (64, 1): {'mean': 0.015625, 'second_moment': 0.015625, 'var': 0.015625}, (64, 2): {'mean': 0.015625, 'second_moment': 0.007813425734639168, 'var': 0.007689432706683874}, (64, 4): {'mean': 0.015625, 'second_moment': 0.003908096347004175, 'var': 0.0037221137899905443}, (64, 6): {'mean': 0.015625, 'second_moment': 0.0026068189181387424, 'var': 0.002400181256234646}, (64, 8): {'mean': 0.015625, 'second_moment': 0.0019566486589610577, 'var': 0.0017396907787770033}, (64, 16): {'mean': 0.015625, 'second_moment': 0.0009840527782216668, 'var': 0.0007516568875871599}, (96, 1): {'mean': 0.010416666977107525, 'second_moment': 0.010416666977107525, 'var': 0.010416666977107525}, (96, 2): {'mean': 0.010416666977107525, 'second_moment': 0.005208631046116352, 'var': 0.005153809208422899}, (96, 4): {'mean': 0.010416666977107525, 'second_moment': 0.002604710403829813, 'var': 0.0025224790442734957}, (96, 6): {'mean': 0.01041666604578495, 'second_moment': 0.0017368746921420097, 'var': 0.0016455086879432201}, (96, 8): {'mean': 0.010416666977107525, 'second_moment': 0.0013030965346843004, 'var': 0.0012071642559021711}, (96, 16): {'mean': 0.010416666977107525, 'second_moment': 0.0006530187092721462, 'var': 0.000550243363250047}, (128, 1): {'mean': 0.0078125, 'second_moment': 0.0078125, 'var': 0.0078125}, (128, 2): {'mean': 0.0078125, 'second_moment': 0.003906366880983114, 'var': 0.0038756101857870817}, (128, 4): {'mean': 0.0078125, 'second_moment': 0.0019533697050064802, 'var': 0.001907234895043075}, (128, 6): {'mean': 0.0078125, 'second_moment': 0.001302411314100027, 'var': 0.0012511508539319038}, (128, 8): {'mean': 0.0078125, 'second_moment': 0.0009769495809450746, 'var': 0.000923126470297575}, (128, 16): {'mean': 0.0078125, 'second_moment': 0.0004891022108495235, 'var': 0.0004314376274123788}, (160, 1): {'mean': 0.006250000558793545, 'second_moment': 0.006250000558793545, 'var': 0.006250000558793545}, (160, 2): {'mean': 0.006250000558793545, 'second_moment': 0.0031250598840415478, 'var': 0.0031054061837494373}, (160, 4): {'mean': 0.006250000558793545, 'second_moment': 0.0015626165550202131, 'var': 0.0015331362374126911}, (160, 6): {'mean': 0.006250000558793545, 'second_moment': 0.0010418277233839035, 'var': 0.0010090719442814589}, (160, 8): {'mean': 0.006250000558793545, 'second_moment': 0.0007814691052772105, 'var': 0.0007470757700502872}, (160, 16): {'mean': 0.006250000558793545, 'second_moment': 0.0003910244267899543, 'var': 0.0003541755140759051}, (192, 1): {'mean': 0.0052083334885537624, 'second_moment': 0.0052083334885537624, 'var': 0.0052083334885537624}, (192, 2): {'mean': 0.0052083334885537624, 'second_moment': 0.0026042063254863024, 'var': 0.0025905719958245754}, (192, 4): {'mean': 0.0052083334885537624, 'second_moment': 0.0013021521735936403, 'var': 0.0012817009119316936}, (192, 6): {'mean': 0.0052083334885537624, 'second_moment': 0.0008681489271111786, 'var': 0.0008454254711978137}, (192, 8): {'mean': 0.0052083334885537624, 'second_moment': 0.000651166366878897, 'var': 0.000627306813839823}, (192, 16): {'mean': 0.0052083334885537624, 'second_moment': 0.0003257522184867412, 'var': 0.00030018898542039096}, (256, 1): {'mean': 0.00390625, 'second_moment': 0.00390625, 'var': 0.00390625}, (256, 2): {'mean': 0.00390625, 'second_moment': 0.0019531394354999065, 'var': 0.0019454803550615907}, (256, 4): {'mean': 0.00390625, 'second_moment': 0.000976590090431273, 'var': 0.0009651011787354946}, (256, 6): {'mean': 0.00390625, 'second_moment': 0.0006510824314318597, 'var': 0.0006383172003552318}, (256, 8): {'mean': 0.00390625, 'second_moment': 0.0004883309011347592, 'var': 0.0004749273357447237}, (256, 16): {'mean': 0.00390625, 'second_moment': 0.00024423617287538946, 'var': 0.00022987532429397106}, (288, 1): {'mean': 0.0034722229465842247, 'second_moment': 0.0034722229465842247, 'var': 0.0034722229465842247}, (288, 2): {'mean': 0.0034722229465842247, 'second_moment': 0.0017361228819936514, 'var': 0.0017300735926255584}, (288, 4): {'mean': 0.0034722229465842247, 'second_moment': 0.0008680747705511749, 'var': 0.0008590011275373399}, (288, 6): {'mean': 0.003472222713753581, 'second_moment': 0.0005787304253317416, 'var': 0.0005686485674232244}, (288, 8): {'mean': 0.0034722229465842247, 'second_moment': 0.000434063229477033, 'var': 0.0004234773223288357}, (288, 16): {'mean': 0.003472222713753581, 'second_moment': 0.0002170803491026163, 'var': 0.00020573839719872922}, (384, 1): {'mean': 0.0026041667442768812, 'second_moment': 0.0026041667442768812, 'var': 0.0026041667442768812}, (384, 2): {'mean': 0.0026041667442768812, 'second_moment': 0.0013020882615819573, 'var': 0.0012986885849386454}, (384, 4): {'mean': 0.0026041667442768812, 'second_moment': 0.0006510498351417482, 'var': 0.0006459503201767802}, (384, 6): {'mean': 0.0026041667442768812, 'second_moment': 0.00043403924792073667, 'var': 0.00042837316868826747}, (384, 8): {'mean': 0.0026041667442768812, 'second_moment': 0.0003255358024034649, 'var': 0.0003195863391738385}, (384, 16): {'mean': 0.0026041667442768812, 'second_moment': 0.00016278799739666283, 'var': 0.00015641364734619856}}
moe_normalization = {(16, 1): {'mean': 0.0625, 'second_moment': 0.0625, 'var': 0.0625}, (16, 2): {'mean': 0.0625, 'second_moment': 0.03357778489589691, 'var': 0.0316496379673481}, (16, 4): {'mean': 0.0625, 'second_moment': 0.018934253603219986, 'var': 0.01602986827492714}, (16, 6): {'mean': 0.0625, 'second_moment': 0.01399240642786026, 'var': 0.010758568532764912}, (16, 8): {'mean': 0.0625, 'second_moment': 0.011605387553572655, 'var': 0.00821241270750761}, (32, 1): {'mean': 0.03125, 'second_moment': 0.03125, 'var': 0.03125}, (32, 2): {'mean': 0.03125, 'second_moment': 0.016673948615789413, 'var': 0.016203751787543297}, (32, 4): {'mean': 0.03125, 'second_moment': 0.009189140982925892, 'var': 0.008477501571178436}, (32, 6): {'mean': 0.03125, 'second_moment': 0.0064955889247357845, 'var': 0.005697058979421854}, (32, 8): {'mean': 0.03125, 'second_moment': 0.005149040371179581, 'var': 0.004307073540985584}, (32, 16): {'mean': 0.03125, 'second_moment': 0.0031605763360857964, 'var': 0.0022544660605490208}, (64, 1): {'mean': 0.015625, 'second_moment': 0.015625, 'var': 0.015625}, (64, 2): {'mean': 0.015625, 'second_moment': 0.008231469430029392, 'var': 0.008114111609756947}, (64, 4): {'mean': 0.015625, 'second_moment': 0.004446877632290125, 'var': 0.00426944624632597}, (64, 6): {'mean': 0.015625, 'second_moment': 0.0031364792957901955, 'var': 0.002938248682767153}, (64, 8): {'mean': 0.015625, 'second_moment': 0.0024370476603507996, 'var': 0.0022277149837464094}, (64, 16): {'mean': 0.015625, 'second_moment': 0.0013804493937641382, 'var': 0.0011543452274054289}, (96, 1): {'mean': 0.010416666977107525, 'second_moment': 0.010416666977107525, 'var': 0.010416666977107525}, (96, 2): {'mean': 0.010416666977107525, 'second_moment': 0.0054546683095395565, 'var': 0.005402436479926109}, (96, 4): {'mean': 0.010416666977107525, 'second_moment': 0.0029351995326578617, 'var': 0.002856447361409664}, (96, 6): {'mean': 0.010416666977107525, 'second_moment': 0.0020081738475710154, 'var': 0.0019196635112166405}, (96, 8): {'mean': 0.010416666977107525, 'second_moment': 0.0015693871537223458, 'var': 0.0014762580394744873}, (96, 16): {'mean': 0.010416666977107525, 'second_moment': 0.0008763103396631777, 'var': 0.0007758854771964252}, (128, 1): {'mean': 0.0078125, 'second_moment': 0.0078125, 'var': 0.0078125}, (128, 2): {'mean': 0.0078125, 'second_moment': 0.004115321207791567, 'var': 0.004086209461092949}, (128, 4): {'mean': 0.0078125, 'second_moment': 0.002179573057219386, 'var': 0.002135219518095255}, (128, 6): {'mean': 0.0078125, 'second_moment': 0.0015049380017444491, 'var': 0.0014552721986547112}, (128, 8): {'mean': 0.0078125, 'second_moment': 0.001173240365460515, 'var': 0.001120962668210268}, (128, 16): {'mean': 0.0078125, 'second_moment': 0.0006310699391178787, 'var': 0.0005745233502238989}, (160, 1): {'mean': 0.006250000558793545, 'second_moment': 0.006250000558793545, 'var': 0.006250000558793545}, (160, 2): {'mean': 0.006250000558793545, 'second_moment': 0.003261986654251814, 'var': 0.003243194194510579}, (160, 4): {'mean': 0.006250000558793545, 'second_moment': 0.001726389629766345, 'var': 0.0016979393549263477}, (160, 6): {'mean': 0.006250000558793545, 'second_moment': 0.0011892914772033691, 'var': 0.0011574630625545979}, (160, 8): {'mean': 0.006250000558793545, 'second_moment': 0.0009293864713981748, 'var': 0.0008959234692156315}, (160, 16): {'mean': 0.006250000558793545, 'second_moment': 0.0004983337130397558, 'var': 0.00046215965994633734}, (192, 1): {'mean': 0.0052083334885537624, 'second_moment': 0.0052083334885537624, 'var': 0.0052083334885537624}, (192, 2): {'mean': 0.0052083334885537624, 'second_moment': 0.0027268410194665194, 'var': 0.0027138488367199898}, (192, 4): {'mean': 0.0052083334885537624, 'second_moment': 0.0014333497965708375, 'var': 0.0014135853853076696}, (192, 6): {'mean': 0.0052083334885537624, 'second_moment': 0.0009889228967949748, 'var': 0.0009668318089097738}, (192, 8): {'mean': 0.0052083334885537624, 'second_moment': 0.0007645292207598686, 'var': 0.0007412632694467902}, (192, 16): {'mean': 0.0052083334885537624, 'second_moment': 0.00041170543408952653, 'var': 0.0003865922335535288}, (256, 1): {'mean': 0.00390625, 'second_moment': 0.00390625, 'var': 0.00390625}, (256, 2): {'mean': 0.00390625, 'second_moment': 0.0020324785728007555, 'var': 0.0020251304376870394}, (256, 4): {'mean': 0.00390625, 'second_moment': 0.0010636788792908192, 'var': 0.001052531530149281}, (256, 6): {'mean': 0.00390625, 'second_moment': 0.0007340146694332361, 'var': 0.000721574469935149}, (256, 8): {'mean': 0.00390625, 'second_moment': 0.0005699380417354405, 'var': 0.0005568544147536159}, (256, 16): {'mean': 0.00390625, 'second_moment': 0.0003030422958545387, 'var': 0.0002889120951294899}, (288, 1): {'mean': 0.0034722229465842247, 'second_moment': 0.0034722229465842247, 'var': 0.0034722229465842247}, (288, 2): {'mean': 0.0034722229465842247, 'second_moment': 0.0018130569951608777, 'var': 0.001807275926694274}, (288, 4): {'mean': 0.0034722229465842247, 'second_moment': 0.0009508688817732036, 'var': 0.0009420837159268558}, (288, 6): {'mean': 0.003472222713753581, 'second_moment': 0.0006576253799721599, 'var': 0.0006478183786384761}, (288, 8): {'mean': 0.003472222713753581, 'second_moment': 0.0005004896665923297, 'var': 0.0004901351640000939}, (288, 16): {'mean': 0.003472222713753581, 'second_moment': 0.00026720089954324067, 'var': 0.0002560335851740092}, (384, 1): {'mean': 0.0026041667442768812, 'second_moment': 0.0026041667442768812, 'var': 0.0026041667442768812}, (384, 2): {'mean': 0.0026041667442768812, 'second_moment': 0.0013523850357159972, 'var': 0.001349116675555706}, (384, 4): {'mean': 0.0026041667442768812, 'second_moment': 0.0007047672988846898, 'var': 0.0006998080061748624}, (384, 6): {'mean': 0.0026041665114462376, 'second_moment': 0.0004860482586082071, 'var': 0.00048051789053715765}, (384, 8): {'mean': 0.0026041667442768812, 'second_moment': 0.0003726038848981261, 'var': 0.0003667773271445185}, (384, 16): {'mean': 0.0026041667442768812, 'second_moment': 0.00019752394291572273, 'var': 0.00019124028040096164}}

# TODO: This is not the correct standard param implementation.
standard_param_impl = {
    'name':                     'SP',
    'embedding': {
        'init_std':             lambda m: 1.0,
        'lr_scale':             lambda m: 1.0,
        'wd_scale':             lambda m: 0.0,
        'output_multiplier':    lambda m: 1.0
    },
    'hidden': {
        'init_std':             lambda m: 1.0 / m**(1/2),
        'lr_scale':             lambda m: 1.0,
        'wd_scale':             lambda m: 1.0,
        'output_multiplier':    lambda m: 1.0
    }, 
    'unembedding': {
        'init_std':             lambda m: 1.0 / m**(1/2),
        'lr_scale':             lambda m: 1.0,
        'wd_scale':             lambda m: 1.0,
        'output_multiplier':    lambda m: 1.0
    },
    'normalization': {
        'lr_scale':             lambda m: 1.0,
    },
    'attention_scale':          lambda d: 1 / d**(1/2),
    'depth_scale':              lambda L: 1.0,
}


mengxi_impl = {
    'name':                     'xLLM (muP) Mengxi Candidate KV Scaling',
    'embedding': {
        # 'init_std':             lambda m: 1.0 / m,
        # 'lr_scale':             lambda m: 1.0 / m,
        # 'wd_scale':             lambda m: m,
        # 'output_multiplier':    lambda m: m,
        'init_std':             lambda m: 1.0,
        'lr_scale':             lambda m: 1.0,
        'wd_scale':             lambda m: 1.0,
        'output_multiplier':    lambda m: 1.0
    },
    'hidden': {
        'init_std':             lambda m: 1 / m**(1/2),
        'lr_scale':             lambda m: 1 / m,
        'wd_scale':             lambda m: m,
        'output_multiplier':    lambda m: 1.0
    },
    'q_layer': {
        # 'init_std':             lambda m, n: 1 / math.sqrt(m*n),
        # 'lr_scale':             lambda m: 1 / m,
        # 'wd_scale':             lambda m: m,
        # 'output_multiplier':    lambda n: math.sqrt(n),
        'init_std':             lambda m: 1 / m**(1/2),
        'lr_scale':             lambda m: 1 / m,
        'wd_scale':             lambda m: m,
        'output_multiplier':    lambda m: 1.0
    },
    'k_layer': {
        # 'init_std':             lambda m, n, r: math.sqrt(r / (m*n)),
        # 'lr_scale':             lambda m: 1 / m,
        # 'wd_scale':             lambda m: m,
        # 'output_multiplier':    lambda n, r: math.sqrt(n / r),
        'init_std':             lambda m, r: 1 / (r*m)**(1/2),
        'lr_scale':             lambda m: 1 / m,
        'wd_scale':             lambda m: m,
        'output_multiplier':    lambda m, r: r**(1/2)
    },
    'v_layer': {
        # 'init_std':             lambda m, r: math.sqrt(r / m),
        # 'lr_scale':             lambda m: 1 / m,
        # 'wd_scale':             lambda m: m,
        # 'output_multiplier':    lambda r: 1 / math.sqrt(r),
        'init_std':             lambda m, r: 1 / (r*m)**(1/2),
        'lr_scale':             lambda m: 1 / m,
        'wd_scale':             lambda m: m,
        'output_multiplier':    lambda m,r: r**(1/2)
    },
    'unembedding': {
        # 'init_std':             lambda m: 1.0 / m,
        # 'lr_scale':             lambda m: 1.0 / m,
        # 'wd_scale':             lambda m: m,
        # 'output_multiplier':    lambda m: 1.0,
        'init_std':             lambda m: 1.0 / m**(1/2),
        'lr_scale':             lambda m: 1.0,
        'wd_scale':             lambda m: 1.0,
        'output_multiplier':    lambda m: 1.0
    },
    'normalization': {
        'lr_scale':             lambda m: 1.0 / m,
    },
    'attention_scale':          lambda d: 1 / d,
    'depth_scale':              lambda L: 1.0 / L,
}

kyle_impl = {
    'name':                     'xLLM (muP) Kyle Candidate KV Scaling',
    'embedding': {
        'init_std':             lambda m: 1.0 / m,
        'lr_scale':             lambda m: 1.0 / m,
        'wd_scale':             lambda m: m,
        'output_multiplier':    lambda m: m,
    },
    'hidden': {
        'init_std':             lambda m: 1.0 / m**(1/2),
        'lr_scale':             lambda m: 1.0 / m,
        'wd_scale':             lambda m: m,
        'output_multiplier':    lambda m: 1.0
    },
    'kv_layer': {
        'init_std':             lambda m, r: (1 + r**(1/2)) / (2 * m**(1/2)),
        'lr_scale':             lambda m, r: 1 / m,
        'wd_scale':             lambda m, r: m,
        'output_multiplier':    lambda m, r: 2 / (1 + r**(1/2)),
    },
    'unembedding': {
        'init_std':             lambda m: 1.0 / m,
        'lr_scale':             lambda m: 1.0 / m,
        'wd_scale':             lambda m: m,
        'output_multiplier':    lambda m: 1.0,
    },
    'normalization': {
        'lr_scale':             lambda m: 1.0 / m,
    },
    'attention_scale':          lambda d: 1 / d,
    'depth_scale':              lambda L: 1.0 / L,
}


impl_dict = {
    'standard_param_impl': standard_param_impl,
    'mengxi_impl': mengxi_impl,
    'kyle_impl': kyle_impl,
}